<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutoria</title>
    <!-- Firebase App, Auth, Functions -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
    body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
    }
    
    header {
        text-align: center;
        margin-bottom: 30px;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .card {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .input-group {
        margin-bottom: 20px;
    }
    
    .input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    
    .input-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
    }
    
    .btn-container {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .btn {
        padding: 12px 24px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s;
    }
    
    .btn:hover {
        background: #0056b3;
    }
    
    .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    
    #btnLogout {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
    }
    
    #btnLogout:hover {
        background: #c82333;
    }
    
    .questions {
        margin-top: 20px;
    }
    
    .question {
        background: #f8f9fa;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        border-left: 4px solid #007bff;
        word-wrap: break-word;
        white-space: pre-wrap;
    }
    
    .question-number {
        font-weight: bold;
        margin-bottom: 10px;
        color: #007bff;
        font-size: 18px;
    }
    
    .loader {
        display: none;
        margin-top: 10px;
        font-style: italic;
        color: #666;
        text-align: center;
        padding: 20px;
    }
    
    .success {
        color: #28a745;
        text-align: center;
        padding: 20px;
    }
    
    .error {
        color: #dc3545;
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 15px;
        border-radius: 5px;
        margin-top: 10px;
    }
    
    .result-container {
        margin-top: 20px;
    }
    
    #user-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
    }
    
    .user-details {
        text-align: left;
    }
    
    @media (max-width: 768px) {
        .btn-container {
            flex-direction: column;
        }
        
        .btn {
            width: 100%;
        }
        
        #user-info {
            flex-direction: column;
            gap: 10px;
        }
    }
    </style>
</head>
<body>
    <header>
        <h1>Gerador de Quest√µes</h1>
        <p class="subtitle">Gerar quest√µes do t√≥pico desejado</p>
        <div id="user-info">
            <div class="user-details">
                <div id="user-name">Carregando...</div>
                <div id="user-email"></div>
            </div>
            <button id="btnLogout">Sair</button>
        </div>
    </header>

    <div class="card">
        <div class="input-group">
            <label for="subject">Assunto:</label>
            <input type="text" id="subject" placeholder="Ex: Matem√°tica, F√≠sica, Biologia, Hist√≥ria..." value="F√≠sica">
        </div>
        <div class="btn-container">
            <button class="btn" onclick="callGenerateQuestions(5)">5 Quest√µes</button>
            <button class="btn" onclick="callGenerateQuestions(10)">10 Quest√µes</button>
            <button class="btn" onclick="callGenerateQuestions(15)">15 Quest√µes</button>
        </div>
        <div class="loader" id="loader">
            <div>üîÑ Gerando quest√µes...</div>
            <div style="font-size: 12px; margin-top: 5px;">Isso pode levar alguns segundos</div>
        </div>
        <div class="result-container">
            <div id="result"><p class="success">üëÜ Selecione um bot√£o acima para gerar quest√µes</p></div>
        </div>
    </div>

    <script>
        // Configura√ß√£o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDbzqfmNxZjuDbkCmjqrKGhB-rTRT6e3oY",
            authDomain: "tutoria-firebase.firebaseapp.com",
            projectId: "tutoria-firebase",
            storageBucket: "tutoria-firebase.firebasestorage.app",
            messagingSenderId: "1070606817177",
            appId: "1:1070606817177:web:53a2624d04d669ff452508"
        };
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions();

        // Configurar regi√£o se necess√°rio
        // const functions = firebase.app().functions('us-central1');

        // Emuladores (apenas para desenvolvimento local)
        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
            auth.useEmulator('http://localhost:9099/');
            db.useEmulator('localhost', 8080);
            functions.useEmulator('localhost', 5001);
        }

        // Verifica autentica√ß√£o e carrega dados do usu√°rio
        auth.onAuthStateChanged(async user => {
            if (!user) {
                window.location.replace('login.html');
                return;
            }
            
            try {
                // Busca dados no Firestore
                const doc = await db.collection('users').doc(user.uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('user-name').textContent = data.nome || user.displayName || 'Usu√°rio';
                    document.getElementById('user-email').textContent = data.email || user.email;
                } else {
                    document.getElementById('user-name').textContent = user.displayName || 'Usu√°rio';
                    document.getElementById('user-email').textContent = user.email;
                }
            } catch (error) {
                console.error('Erro ao carregar dados do usu√°rio:', error);
                document.getElementById('user-name').textContent = user.displayName || 'Usu√°rio';
                document.getElementById('user-email').textContent = user.email;
            }
        });

        // Logout
        document.getElementById('btnLogout').addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.replace('login.html');
            }).catch(error => {
                console.error('Erro ao fazer logout:', error);
            });
        });

        // Fun√ß√£o para gerar quest√µes - VERS√ÉO ATUALIZADA PARA CORS
        async function callGenerateQuestions(count) {
            const subject = document.getElementById('subject').value.trim();
            
            if (!subject) {
                showError('Por favor, digite um assunto antes de gerar as quest√µes.');
                return;
            }

            // Desabilitar bot√µes durante o processo
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(btn => btn.disabled = true);
            
            document.getElementById('loader').style.display = 'block';
            document.getElementById('result').innerHTML = '';

            try {
                // M√âTODO 1: Usando httpsCallable (recomendado se mantiver onCall no backend)
                const generateQuestions = functions.httpsCallable('generateQuestions');
                const result = await generateQuestions({ subject, count });
                
                if (result.data && result.data.questions) {
                    displayQuestions(result.data.questions);
                } else {
                    throw new Error('Formato de resposta inv√°lido');
                }

            } catch (error) {
                console.error('Erro ao gerar quest√µes:', error);
                
                // M√âTODO 2: Fallback usando fetch direto (para onRequest)
                try {
                    console.log('Tentando m√©todo alternativo...');
                    
                    const user = auth.currentUser;
                    if (!user) {
                        throw new Error('Usu√°rio n√£o autenticado');
                    }
                    
                    const token = await user.getIdToken();
                    const functionUrl = `https://us-central1-tutoria-firebase.cloudfunctions.net/generateQuestions`;
                    
                    const response = await fetch(functionUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`,
                        },
                        body: JSON.stringify({
                            data: { subject, count }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.data && data.data.questions) {
                        displayQuestions(data.data.questions);
                    } else {
                        throw new Error('Formato de resposta inv√°lido no m√©todo alternativo');
                    }

                } catch (fetchError) {
                    console.error('Erro no m√©todo alternativo:', fetchError);
                    showError(`Falha ao gerar quest√µes. Detalhes: ${error.message || 'Erro desconhecido'}`);
                }
            } finally {
                document.getElementById('loader').style.display = 'none';
                buttons.forEach(btn => btn.disabled = false);
            }
        }

        function displayQuestions(questions) {
            if (!questions || !Array.isArray(questions) || questions.length === 0) {
                showError('Nenhuma quest√£o foi gerada. Por favor, tente novamente.');
                return;
            }

            let html = '<div class="questions">';
            
            questions.forEach((question, index) => {
                // Verifica se a quest√£o √© um objeto JSON ou string
                let questionContent;
                
                if (typeof question === 'string') {
                    // Se for string, tenta fazer parse para JSON
                    try {
                        const parsedQuestion = JSON.parse(question);
                        questionContent = formatStructuredQuestion(parsedQuestion, index + 1);
                    } catch (e) {
                        // Se n√£o conseguir fazer parse, usa como texto simples
                        questionContent = question;
                    }
                } else if (typeof question === 'object') {
                    // Se j√° for objeto, formata estruturadamente
                    questionContent = formatStructuredQuestion(question, index + 1);
                } else {
                    questionContent = String(question);
                }
                
                html += `
                    <div class="question">
                        <div class="question-number">Quest√£o ${index + 1}</div>
                        <div>${questionContent}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('result').innerHTML = html;
        }

        function formatStructuredQuestion(questionObj, number) {
            if (!questionObj.enunciado) {
                return JSON.stringify(questionObj, null, 2);
            }

            let html = `<strong>Enunciado:</strong><br>${questionObj.enunciado}<br><br>`;
            
            if (questionObj.alternativas && Array.isArray(questionObj.alternativas)) {
                html += '<strong>Alternativas:</strong><br>';
                const letters = ['A', 'B', 'C', 'D', 'E'];
                questionObj.alternativas.forEach((alt, index) => {
                    const letter = letters[index] || (index + 1);
                    const isCorrect = questionObj.alternativaCorreta === letter;
                    html += `${letter}) ${alt}${isCorrect ? ' ‚úì' : ''}<br>`;
                });
                html += '<br>';
            }
            
            if (questionObj.alternativaCorreta) {
                html += `<strong>Resposta:</strong> ${questionObj.alternativaCorreta}<br>`;
            }
            
            if (questionObj.materia) {
                html += `<strong>Mat√©ria:</strong> ${questionObj.materia}<br>`;
            }
            
            if (questionObj.assunto) {
                html += `<strong>Assunto:</strong> ${questionObj.assunto}<br>`;
            }
            
            if (questionObj.nivel) {
                html += `<strong>N√≠vel:</strong> ${questionObj.nivel}`;
            }
            
            return html;
        }

        function showError(message) {
            document.getElementById('result').innerHTML = `<div class="error">‚ùå ${message}</div>`;
        }

        // Adicionar evento de Enter no campo de assunto
        document.getElementById('subject').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                callGenerateQuestions(5);
            }
        });
    </script>
</body>
</html>